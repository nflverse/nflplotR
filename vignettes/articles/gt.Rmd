---
title: "nflplotR & the gt Package"
description: "How nflplotR works as gt extension"
author: "Sebastian Carl"
opengraph:
  image: 
    src: "https://raw.githubusercontent.com/nflverse/nflplotR/main/man/figures/social_preview_gt.png"
  twitter:
    card: summary_large_image
    creator: "@mrcaseb"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{nflplotR & the gt Package}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  out.width = "100%",
  dpi = 600
)
options(nflreadr.cache_warning = FALSE)
options(warn = -1)
```

The R package [{gt}](https://gt.rstudio.com/) is becoming increasingly popular for creating aesthetically pleasing tables. nflplotR supports rendering of team logos, team wordmarks, and player headshots in gt tables similar to ggplot2. This article will provide some typical examples. 

## Team Logos & Wordmarks

The functions `gt_nfl_logos()` and `gt_nfl_wordmarks()` come with a powerful `locations` argument that allows usage of gt selection helpers. We will create an example dataframe to show how this all works.

```{r}
df <- data.frame(
  row_group_column = c("AFC", "NFC", "AFC", "NFC"),
  row_name_column = c("LAC", "SEA"),
  column_a = 11:12,
  column_b = c("KC", "LA")
) 
```

Our example dataframe in a gt table without any formatting.

```{r}
gt::gt(df)
```

The column `row_group_column` is intended to serve as row group variable so let's apply this.

```{r}
gt::gt(df, groupname_col = "row_group_column")
```

We also would like to render images in the stub, i.e. the rownames so we tell gt about the `row_name_column`. 

```{r}
example_table <- gt::gt(
  df, 
  groupname_col = "row_group_column", 
  rowname_col = "row_name_column"
) |> 
  # align the complete table left
  gt::tab_options(
    table.align = "left"
  )
example_table
```

This is our final table. We have valid NFL abbreviations in the cell body, in row group labels and in the stub. We can now use nflplotR to render images instead of those abbreviations.

### Cell Body

To render images in the cell body, i.e. the rows of the table, we can either use the `columns` argument or the appropriate `locations` helper.

```{r}
example_table |> 
  nflplotR::gt_nfl_logos(columns = "column_b")
```

Please note, that the locations helper will allow you to selectively apply the function to a set of rows

```{r}
example_table |> 
  nflplotR::gt_nfl_logos(locations = gt::cells_body(rows = gt::starts_with("LAC")))
```


### Row Group Label

Rendering images outside of the cell body will always require the appropriate call to the `locations` argument. The `columns` argument cannot handle anything outside cell bodies.

```{r}
example_table |> 
  nflplotR::gt_nfl_logos(locations = gt::cells_row_groups())
```

### Stub

Now we would like to convert rownames to images.

```{r}
example_table |> 
  nflplotR::gt_nfl_wordmarks(locations = gt::cells_stub())
```

### Column Spanners

We use another table to demonstrate how to convert team names to logos and wordmarks in column spanners.

Here only logos

```{r, fig.align='left'}
df <- data.frame(a = 3, b = 4, c = 5, d = 6)

df |> 
  gt::gt() |> 
  gt::tab_spanner("KC", c(a, b)) |> 
  gt::tab_spanner("LAC", c(c, d)) |> 
  nflplotR::gt_nfl_logos(locations = gt::cells_column_spanners())
```

And now mix logo and wordmark

```{r, fig.align='left'}
df <- data.frame(a = 3, b = 4, c = 5, d = 6)

df |> 
  gt::gt() |> 
  gt::tab_spanner("KC", c(a, b)) |> 
  gt::tab_spanner("LAC", c(c, d)) |> 
  nflplotR::gt_nfl_logos(locations = gt::cells_column_spanners("KC")) |> 
  nflplotR::gt_nfl_wordmarks(locations = gt::cells_column_spanners("LAC"))
```

### Combine all together

The `locations` argument allows multiple locations in one call by wrapping them in a list.

```{r}
example_table |> 
  nflplotR::gt_nfl_wordmarks(locations = gt::cells_stub()) |> 
  nflplotR::gt_nfl_logos(
    locations = list(
      gt::cells_body(), gt::cells_row_groups()
    )
  )
```

### How about Column Labels?

Well...it's complicated, because [gt behaves inconsistent in my opinion](https://github.com/rstudio/gt/issues/1433).

The actually correct way would be a call to `nflplotR::gt_nfl_logos` or `nflplotR::gt_nfl_wordmarks` with the `locations` argument set to `gt::cells_column_labels()`. Currently, this wouldn't render any images in column labels as discussed in the above linked issue. 

However, as a convenient workaround, nflplotR supports logos and wordmarks in column labels through `gt_nfl_cols_label()`. 

LOGOS:

```{r}
teams <- nflplotR::valid_team_names() |> head(6)
df <- cbind(1, 2, 3, 4, 5, 6) |> 
  as.data.frame() |> 
  rlang::set_names(teams)

gt::gt(df) |> 
  nflplotR::gt_nfl_cols_label() |> 
  # align the complete table left
  gt::tab_options(
    table.align = "left"
  )
```

WORDMARKS (note how non matches remain unchanged):

```{r}
gt::gt(df) |> 
  nflplotR::gt_nfl_cols_label(type = "wordmark") |> 
  # align the complete table left
  gt::tab_options(
    table.align = "left"
  )
```

HEADSHOTS:

```{r}
headshot_df <- data.frame(
  "00-0036355" = 1, 
  "00-0033873" = 2,
  check.names = FALSE
)
gt::gt(headshot_df) |> 
  nflplotR::gt_nfl_cols_label(type = "headshot") |> 
  # align the complete table left
  gt::tab_options(
    table.align = "left"
  )
```

### Logos and Wordmarks Rendered by nflplotR

This example creates a table that renders all team logos and wordmarks. We split the table into 2 x 16 rows to avoid an overly long table and convert all variables starting with "logo" to logos and all variables starting with "wordmark" to wordmarks. 

```{r}
teams <- nflplotR::valid_team_names()
# remove conference logos from this example
teams <- teams[!teams %in% c("AFC", "NFC", "NFL")]
# create dataframe with all 32 team names
df <- data.frame(
  team_a = head(teams, 16),
  logo_a = head(teams, 16),
  wordmark_a = head(teams, 16),
  team_b = tail(teams, 16),
  logo_b = tail(teams, 16),
  wordmark_b = tail(teams, 16)
)
# create gt table and translate team names to logo/wordmark images
df |>
  gt::gt() |>
  nflplotR::gt_nfl_logos(columns = gt::starts_with("logo")) |>
  nflplotR::gt_nfl_wordmarks(columns = gt::starts_with("wordmark")) |> 
  # align the complete table left
  gt::tab_options(
    table.align = "left"
  )
```

## Player Headshots

All of the above applies to `gt_nfl_headshots()` as well. All you need is a gsis ID. 

```{r}
df <- data.frame(
  A = c("00-0036355", "00-0033873"),
  B = c("00-0033077", "00-0035228")
)

df |>
  gt::gt() |> 
  nflplotR::gt_nfl_headshots(columns = gt::everything(), height = 50) |> 
  # align the complete table left
  gt::tab_options(
    table.align = "left"
  )
```

## Add Context to Data Values

When presenting data, whether in tables or other forms, context matters. For example, if you explain to a layperson that an NFL quarterback has a completion rate of 80%, they will not be able to interpret this value without context. Is it average, below average, or an incredible record? 

There are various ways to add this context to tables. Statistically, a particular value can be classified very well by specifying its empirical quantile (usually given as a percentile). Once the percentiles have been determined, one can use `gt::cols_merge_n_pct`, for example, to add the context (the percentile) to the value. More complex styles can be implemented using the `pattern` argument in `gt::cols_merge`.

This chapter introduces another method of graphically representing quantiles in tables. The basic idea is that a "progress bar" is rendered which is filled between 0% and 100%, depending on the empirical quantile. Let's take a look at some examples below.

### Example Data

```{r}
df <- data.frame(
  letters = sample(LETTERS, 10, TRUE),
  value = sample(100:500, 10, FALSE),
  pctl = rev(c(0, 1, 5, 10, 20, 45, 50, 75, 98, 100))
)
```

### The Inline Percentage Bar

By default, a bar is inserted and the value is printed inside the bar. We set `hide_col_pct` (which is not the default) to make it easier to understand how the filling corresponds to the values in `pctl`. 

```{r}
gt::gt(df) |> 
  nflplotR::gt_pct_bar(
    "value", "pctl",
    hide_col_pct = FALSE
  )
```

This doesn't really look good because values aren't aligned and bars are short. So let's change the column width and look again.

```{r}
gt::gt(df) |> 
  nflplotR::gt_pct_bar(
    "value", "pctl",
    hide_col_pct = FALSE
  ) |> 
  gt::cols_width(value ~ gt::px(200))
```

The bars look better but notice how values are aligned right **inside the filled bars**. This is an important information that we can use to improve the style.

Now let's align left and apply a left side padding:

```{r}
gt::gt(df) |> 
  nflplotR::gt_pct_bar(
    "value", "pctl",
    hide_col_pct = FALSE,
    value_padding_left = "10px"
  ) |> 
  gt::cols_width(value ~ gt::px(200)) |> 
  gt::cols_align("left", "value")
```

Two annoying things remain. Some values corresponding to small percentiles overlap with the bars and very small percentiles (see `pctl` <= 5) overlap the outline. We can fix overlapping values and bars by applying separate padding values for every percentile (**all function arguments of `gt_pct_bar` are vectorized**). Rendering of very short percentile bars can be messed up by the border radius of the bar, which is why we see bars overlapping the outline. So let's try and fix this

```{r}
gt::gt(df) |> 
  nflplotR::gt_pct_bar(
    "value", "pctl",
    hide_col_pct = FALSE,
    value_padding_left = ifelse(df$pctl < 25, "110%", "10px"),
    fill_border.radius = "3px",
    background_border.radius = "5px"
  ) |> 
  gt::cols_width(value ~ gt::px(200)) |> 
  gt::cols_align("left", "value")
```

### The Extra Percentage Bar

As an alternative to the inline percentage bar, you can also place the bar below the text. `gt_pct_bar` controls this via the `value_position` argument. This approach allows for a significantly flatter design of the bars, because the text is printed outside the bar.

```{r}
gt::gt(df) |> 
  nflplotR::gt_pct_bar(
    "value", "pctl",
    hide_col_pct = FALSE,
    value_position = "above",
    # with value_position = "above", we need an absolute value of bar heights!
    background_fill.height = "5px",
    background_fill.color = "LightGray"
  ) |> 
  gt::cols_width(value ~ gt::px(100)) |> 
  gt::cols_align("center", "value")
```

### Integrated Color Scales

`gt_pct_bar` can work with any color palette (= vector of color names allowed in html). It also comes with 3 integrated palettes named "hulk", "hulk_teal", and "blue_orange". The default "hulk" palette is used in the above examples. Below we'll look at the other color scales.

Here is an example with the integrated "hulk_teal" color scale.

```{r}
gt::gt(df) |> 
  nflplotR::gt_pct_bar(
    "value", "pctl",
    hide_col_pct = FALSE,
    value_padding_left = ifelse(df$pctl < 25, "110%", "10px"),
    fill_border.radius = "3px",
    background_border.radius = "5px",
    fill_palette = "hulk_teal"
  ) |> 
  gt::cols_width(value ~ gt::px(200)) |> 
  gt::cols_align("left", "value")
```

And another example with the integrated "blue_orange" color scale.

```{r}
gt::gt(df) |> 
  nflplotR::gt_pct_bar(
    "value", "pctl",
    hide_col_pct = FALSE,
    value_padding_left = ifelse(df$pctl < 25, "110%", "10px"),
    fill_border.radius = "3px",
    background_border.radius = "5px",
    fill_palette = "blue_orange"
  ) |> 
  gt::cols_width(value ~ gt::px(200)) |> 
  gt::cols_align("left", "value")
```

### Advanced Styling

`gt_pct_bar` supports advanced styling of the background bar (through `background_style.props`), the fill bar (through `fill_style.props`), and the text (through `text_style.props`) via named lists of the form `list(property = value)`. It is possible to pass every style property to these lists that is [supported in html](https://www.w3schools.com/cssref/index.php).

Here is an example where we overwrite the text color to be red and change the font weight to a bold font. Values in the property lists will overwrite default values.

```{r}
gt::gt(df) |> 
  nflplotR::gt_pct_bar(
    "value", "pctl",
    hide_col_pct = FALSE,
    value_position = "above",
    background_fill.height = "5px",
    background_fill.color = "LightGray",
    value_style.props = list(
      color = "red", "font-weight" = 900
    )
  ) |> 
  gt::cols_width(value ~ gt::px(100)) |> 
  gt::cols_align("center", "value")
```
